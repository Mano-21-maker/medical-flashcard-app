<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Medical Flashcard Study App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for medical look and card flip effect */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff; /* Light blue background */
        }
        .flashcard-container {
            perspective: 1000px; /* Needed for 3D flip effect */
            max-width: 750px; /* Increased Max Width */
            width: 90%; /* Responsive width */
            height: 300px;
            margin: 0 auto;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.2);
            user-select: none;
        }
        .card-front {
            background-color: #ffffff;
            border: 2px solid #3b82f6;
            z-index: 2;
        }
        .card-back {
            background-color: #3b82f6;
            color: white;
            transform: rotateY(180deg);
        }
    </style>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Set Firebase Log Level to Debug
        setLogLevel('Debug');

        // Global variables MUST be present in the script where Firebase is used
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        window.flashcardApp = window.flashcardApp || {}; // Ensure global object exists

        // Function to initialize Firebase and sign in
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in using the custom token or anonymously if not available
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be resolved
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
                        document.getElementById('statusMessage').textContent = 'Authenticated. Connecting to deck...';
                        console.log("Authenticated with User ID:", userId);
                        
                        window.flashcardApp.db = db; // Make db accessible globally
                        window.flashcardApp.userId = userId;
                        window.flashcardApp.appId = appId;
                        window.flashcardApp.startListeningForCards(); // Start data retrieval after auth
                    } else {
                        console.error("Auth state failed to resolve.");
                        document.getElementById('statusMessage').textContent = 'Error: Authentication failed.';
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('statusMessage').textContent = `Error: Cannot load database. ${error.message}`;
            }
        }

        // Function to set up the real-time listener for flashcards
        window.flashcardApp.startListeningForCards = function() {
            if (!db || !userId) return;

            const cardsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'medicalFlashcards');

            // onSnapshot sets up a real-time listener
            onSnapshot(cardsCollectionRef, (snapshot) => {
                const newCards = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Call the handler defined in the main script block to update the UI
                if (window.flashcardApp.handleCardsUpdate) {
                     window.flashcardApp.handleCardsUpdate(newCards);
                }

                // Update status message based on data
                if (newCards.length > 0) {
                    document.getElementById('statusMessage').textContent = `Deck Loaded: ${newCards.length} Cards`;
                } else {
                    document.getElementById('statusMessage').textContent = 'No cards found. Be the first to add one below!';
                }
            }, (error) => {
                console.error("Error fetching cards:", error);
                document.getElementById('statusMessage').textContent = 'Error fetching cards from database.';
            });
        };

        // Function to add a new card
        window.flashcardApp.addCard = async function(term, definition) {
            if (!db || !userId) {
                document.getElementById('statusMessage').textContent = 'Database not ready. Please wait for authentication.';
                return;
            }

            const cardsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'medicalFlashcards');
            
            try {
                await addDoc(cardsCollectionRef, {
                    term: term,
                    definition: definition,
                    createdAt: new Date().toISOString(),
                    createdBy: userId 
                });
                document.getElementById('statusMessage').textContent = 'Card successfully added to the shared deck!';
                document.getElementById('termInput').value = '';
                document.getElementById('definitionInput').value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
                document.getElementById('statusMessage').textContent = `Error saving card: ${e.message}`;
            }
        };

        // Start the initialization process
        initializeFirebase();
    </script>
    
</head>
<body class="min-h-screen flex flex-col items-center pt-10 pb-20">

    <!-- Header -->
    <header class="mb-10 text-center">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
            Collaborative Medical Flashcards
        </h1>
        <p class="text-xl text-gray-600">Click the card to reveal the definition, or add your own terms!</p>
        <p id="statusMessage" class="text-sm text-yellow-600 mt-2 font-medium">Initializing Database...</p>
        <p id="userIdDisplay" class="text-xs text-gray-400 mt-1">User ID: Loading...</p>
    </header>

    <!-- Flashcard Container -->
    <div class="flashcard-container mb-8">
        <div id="flashcard" class="flashcard">
            
            <!-- Card Front (Term) -->
            <div class="card-face card-front">
                <p id="card-term" class="text-3xl font-bold text-gray-800">
                    Loading Deck...
                </p>
            </div>
            
            <!-- Card Back (Definition) -->
            <div class="card-face card-back">
                <p id="card-definition" class="text-xl font-medium">
                    Please wait for the database to load.
                </p>
            </div>
            
        </div>
    </div>

    <!-- Controls -->
    <div class="flex space-x-4 mb-12">
        <button id="nextCardButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-full transition duration-300 transform hover:scale-105 shadow-lg">
            Next Card (0/0)
        </button>
    </div>
    
    <!-- Card Submission Form -->
    <section class="max-w-xl w-full p-6 bg-white rounded-xl shadow-2xl border-t-4 border-green-500">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">
            âž• Add a New Flashcard
        </h2>
        <form id="addCardForm" class="space-y-4">
            <div>
                <label for="termInput" class="block text-sm font-medium text-gray-700">Medical Term (Question)</label>
                <input type="text" id="termInput" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
            </div>
            <div>
                <label for="definitionInput" class="block text-sm font-medium text-gray-700">Definition / Explanation (Answer)</label>
                <textarea id="definitionInput" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500"></textarea>
            </div>
            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-md transition duration-300 shadow-md">
                Save Card to Shared Deck
            </button>
        </form>
    </section>


    <!-- JavaScript for Flashcard Logic and Form Handling -->
    <script>
        // Ensure the global object exists before attaching functions and state
        window.flashcardApp = window.flashcardApp || {};
        
        // Initialize state variables for the main script scope
        window.flashcardApp.flashcards = [];
        window.flashcardApp.currentCardIndex = 0;


        // --- NEW DATA HANDLER: This function processes new data from the database listener ---
        window.flashcardApp.handleCardsUpdate = function(newCards) {
            window.flashcardApp.flashcards = newCards;
            window.flashcardApp.currentCardIndex = 0; // Reset index to the start of the deck
            
            // Check if there are cards to display
            if (newCards.length > 0) {
                window.flashcardApp.loadCard(0);
            } else {
                // Set default text if deck is empty
                document.getElementById('card-term').textContent = 'Deck Empty';
                document.getElementById('card-definition').textContent = 'Use the form below to add a card!';
                document.getElementById('nextCardButton').textContent = 'Next Card (0/0)';
            }
        }


        // --- FLASHCARD DISPLAY FUNCTIONS ---

        // Function to load a specific card's data
        window.flashcardApp.loadCard = function(index) {
            const flashcards = window.flashcardApp.flashcards;
            const termElement = document.getElementById('card-term');
            const definitionElement = document.getElementById('card-definition');
            const nextButton = document.getElementById('nextCardButton');

            if (flashcards.length === 0) {
                termElement.textContent = 'Deck Empty';
                definitionElement.textContent = 'Use the form to add cards.';
                nextButton.textContent = 'Next Card (0/0)';
                return;
            }

            const card = flashcards[index];
            termElement.textContent = card.term;
            definitionElement.textContent = card.definition;
            nextButton.textContent = `Next Card (${index + 1}/${flashcards.length})`;
        }

        // Function to flip the card
        function flipCard() {
            document.getElementById('flashcard').classList.toggle('flipped');
        }

        // Function to go to the next card
        function nextCard() {
            const flashcardElement = document.getElementById('flashcard');
            const flashcards = window.flashcardApp.flashcards;

            if (flashcards.length === 0) return;

            // 1. Flip the card back to the term side (if it was flipped)
            flashcardElement.classList.remove('flipped');
            
            // 2. Wait for the flip animation to finish before changing content
            setTimeout(() => {
                // Move to the next index, or loop back to 0 if we reached the end
                window.flashcardApp.currentCardIndex = (window.flashcardApp.currentCardIndex + 1) % flashcards.length;
                window.flashcardApp.loadCard(window.flashcardApp.currentCardIndex);
            }, 300); // 300ms is half of the transition time
        }

        // --- FORM SUBMISSION HANDLING ---

        document.getElementById('addCardForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Stop the page from reloading
            
            const term = document.getElementById('termInput').value.trim();
            const definition = document.getElementById('definitionInput').value.trim();

            if (term && definition) {
                // Call the function defined in the module script to save the card
                window.flashcardApp.addCard(term, definition);
            } else {
                document.getElementById('statusMessage').textContent = 'Please fill both the term and definition fields.';
            }
        });

        // --- INITIAL EVENT LISTENERS ---
        
        // When the card is clicked, flip it
        document.getElementById('flashcard').addEventListener('click', flipCard);

        // When the "Next Card" button is clicked, move to the next card
        document.getElementById('nextCardButton').addEventListener('click', nextCard);

        // Initial setup for the card display (will be overwritten by the database listener)
        window.flashcardApp.loadCard(0);
    </script>

</body>
</html>